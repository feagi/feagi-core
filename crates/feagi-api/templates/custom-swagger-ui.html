<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FEAGI API Documentation</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.9.0/swagger-ui.css"/>
  
  <style>
    /* Default to dark theme colors */
    :root {
      --primary-color: #19b6b5;
      --primary-color-light: #55dada;
      --background-dark: #121417;
      --background-medium: #1f2426;
      --background-light: #2c3133;
      --accent-gray: #B2BEC3;
      --text-primary: #f1f1f1;
      --text-secondary: #a0a5ab;
      --method-get: #44d9d8;
      --method-post: #5fe3e3;
      --method-put: #7feeee;
      --method-delete: #a2f9f9;
      --border-color: #3b3f42;
      --shadow-color: rgba(0, 0, 0, 0.3);
      --header-bg: #222;
      --header-text: #fff;
      --filter-bg: #333;
      --filter-text: #fff;
    }
    
    /* Light theme colors - applied when [data-theme="light"] */
    [data-theme="light"] {
      --primary-color: #007b8a;
      --primary-color-light: #00a5b8;
      --background-dark: #ffffff;
      --background-medium: #f9fafa;
      --background-light: #e9eff1;
      --accent-gray: #c0ccd4;
      --text-primary: #1e2b33;
      --text-secondary: #5c6b74;
      --method-get: #00b894;
      --method-post: #0984e3;
      --method-put: #fdcb6e;
      --method-delete: #d63031;
      --border-color: #d0d6da;
      --shadow-color: rgba(0, 0, 0, 0.08);
      --header-bg: #f9f9f9;
      --header-text: #000;
      --filter-bg: #f0f0f0;
      --filter-text: #333;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background-dark);
      color: var(--text-primary);
    }
    
    /* Swagger UI Base Styles */
    .swagger-ui {
      background-color: var(--background-dark);
      color: var(--text-primary);
    }
    
    /* Header */
    .swagger-ui .topbar {
      background-color: var(--background-medium);
      border-bottom: 1px solid var(--border-color);
      box-shadow: 0 2px 6px var(--shadow-color);
    }
    
    .swagger-ui .topbar .topbar-wrapper img {
      filter: brightness(1.3);
    }
    
    [data-theme="light"] .swagger-ui .topbar .topbar-wrapper img {
      filter: brightness(0.8);
    }
    
    /* Info Section */
    .swagger-ui .info {
      background-color: var(--background-dark);
      border-bottom: 1px solid var(--border-color);
      margin: 20px 0;
    }
    
    .swagger-ui .info .title {
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .swagger-ui .info .title small.version-stamp {
      background-color: var(--primary-color);
      color: var(--text-primary);
      border-radius: 12px;
      padding: 4px 10px;
    }
    
    /* Operation Blocks */
    .swagger-ui .opblock {
      background-color: var(--background-medium);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      box-shadow: 0 3px 10px var(--shadow-color);
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    .swagger-ui .opblock .opblock-summary {
      border-bottom: 1px solid var(--border-color);
      padding: 12px 16px;
    }
    
    .swagger-ui .opblock .opblock-summary-method {
      font-weight: bold;
      border-radius: 6px;
      min-width: 80px;
      text-align: center;
      padding: 4px 8px;
      color: var(--background-dark);
    }
    
    [data-theme="light"] .swagger-ui .opblock .opblock-summary-method {
      color: white;
    }
    
    .swagger-ui .opblock .opblock-summary-path {
      color: var(--text-primary);
      font-weight: 500;
    }
    
    .swagger-ui .opblock .opblock-summary-description {
      color: var(--text-secondary);
    }
    
    /* HTTP Methods */
    .swagger-ui .opblock.opblock-get {
      border-left: 4px solid var(--method-get);
    }
    
    .swagger-ui .opblock.opblock-get .opblock-summary-method {
      background-color: var(--method-get);
    }
    
    .swagger-ui .opblock.opblock-post {
      border-left: 4px solid var(--method-post);
    }
    
    .swagger-ui .opblock.opblock-post .opblock-summary-method {
      background-color: var(--method-post);
    }
    
    .swagger-ui .opblock.opblock-put {
      border-left: 4px solid var(--method-put);
    }
    
    .swagger-ui .opblock.opblock-put .opblock-summary-method {
      background-color: var(--method-put);
    }
    
    .swagger-ui .opblock.opblock-delete {
      border-left: 4px solid var(--method-delete);
    }
    
    .swagger-ui .opblock.opblock-delete .opblock-summary-method {
      background-color: var(--method-delete);
    }
    
    /* Operation Content */
    .swagger-ui .opblock-body {
      background-color: var(--background-medium);
      padding: 16px;
    }
    
    .swagger-ui .opblock-description-wrapper p,
    .swagger-ui .opblock-external-docs-wrapper p,
    .swagger-ui .opblock-title_normal p {
      color: var(--text-primary);
    }
    
    /* Models */
    .swagger-ui section.models {
      background-color: var(--background-medium);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 2px 6px var(--shadow-color);
    }
    
    .swagger-ui section.models .model-container {
      background-color: var(--background-light);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin: 10px;
    }
    
    .swagger-ui section.models h4 {
      color: var(--text-primary);
      font-weight: 600;
    }
    
    /* Schema */
    .swagger-ui .model-box {
      background-color: var(--background-light);
      border: 1px solid var(--border-color);
      border-radius: 6px;
    }
    
    .swagger-ui .model {
      color: var(--text-primary);
    }
    
    .swagger-ui .model-title {
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .swagger-ui .property {
      color: var(--text-primary);
      font-weight: 500;
    }
    
    .swagger-ui .property-type {
      color: var(--text-secondary);
    }
    
    /* Tables */
    .swagger-ui table thead tr th {
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
      background-color: var(--background-light);
      padding: 12px;
    }
    
    .swagger-ui table tbody tr td {
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
      padding: 10px;
    }
    
    .swagger-ui table tbody tr:hover td {
      background-color: var(--background-medium);
    }
    
    /* Forms */
    .swagger-ui .parameters-col_description input[type=text],
    .swagger-ui .parameters-col_description select,
    .swagger-ui textarea {
      background-color: var(--background-dark);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px 12px;
    }
    
    .swagger-ui .parameters-col_description input[type=text]:focus,
    .swagger-ui .parameters-col_description select:focus,
    .swagger-ui textarea:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(25, 182, 181, 0.4);
    }
    
    /* Buttons */
    .swagger-ui .btn {
      background-color: var(--primary-color);
      color: var(--text-primary);
      border: none;
      border-radius: 6px;
      padding: 10px 18px;
      font-weight: 500;
      box-shadow: 0 2px 6px var(--shadow-color);
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .swagger-ui .btn:hover {
      background-color: var(--primary-color-light);
      transform: translateY(-1px);
    }
    
    .swagger-ui .btn.execute {
      background-color: var(--method-post);
      color: #003b3b;
    }
    
    .swagger-ui .btn.execute:hover {
      background-color: #8ef0f0;
      color: #002222;
    }
    
    [data-theme="light"] .swagger-ui .btn.execute {
      color: white;
    }
    
    button.btn.btn-clear.opblock-control__btn {
      background-color: var(--method-post);
      color: #333333;
      border: 1px solid transparent;
      padding: 6px 12px;
      font-weight: bold;
      border-radius: 5px;
    }
    
    button.btn.btn-clear.opblock-control__btn:hover {
      background-color: #8ef0f0;
      color: #333;
    }
    
    /* Code Blocks */
    .swagger-ui .highlight-code {
      background-color: var(--background-light);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 12px;
    }
    
    .swagger-ui .microlight {
      color: var(--text-primary);
      font-family: 'Fira Code', 'Roboto Mono', monospace;
      font-size: 14px;
    }
    
    /* Response Section */
    .swagger-ui .responses-inner {
      background-color: var(--background-medium);
      padding: 16px;
      border-radius: 6px;
    }
    
    .swagger-ui .responses-inner h4,
    .swagger-ui .responses-inner h5 {
      color: var(--text-primary);
      font-weight: 600;
    }
    
    .swagger-ui .response-col_status {
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .swagger-ui .response-col_description,
    .swagger-ui .response-col_links {
      color: var(--text-primary);
    }
    
    /* Scrollbars */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--background-dark);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--background-light);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-color);
    }
    
    /* Tabs */
    .swagger-ui .tab {
      color: var(--text-primary);
      padding: 10px 15px;
    }
    
    .swagger-ui .tab.active {
      color: var(--primary-color);
      font-weight: 600;
    }
    
    /* Authorization */
    .swagger-ui .auth-container {
      background-color: var(--background-medium);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 16px;
      margin: 12px 0;
    }
    
    .swagger-ui .auth-container h3 {
      color: var(--text-primary);
      font-weight: 600;
    }
    
    /* Tags */
    .swagger-ui .opblock-tag {
      background-color: var(--background-medium);
      color: var(--primary-color);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      box-shadow: 0 2px 4px var(--shadow-color);
      padding: 12px;
      font-weight: 600;
    }
    
    .custom-header {
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      border-bottom: 1px solid #ccc;
      background: var(--header-bg, #f9f9f9);
    }
    
    .custom-header h1 {
      font-size: 1.5em;
      margin: 0;
      flex: 1 1 auto;
      color: var(--header-text, #000);
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .header-button {
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      background-color: #007acc;
      color: white;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.2s;
    }
    
    .header-button:hover { background-color: #005fa3; }
    
    .header-button.load-essential {
      background-color: #dc3545;
    }
    .header-button.load-essential:hover {
      background-color: #c82333;
    }
    
    .header-button.load-barebones {
      background-color: #28a745;
    }
    .header-button.load-barebones:hover {
      background-color: #218838;
    }
    
    .theme-selector {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .theme-selector-label {
      font-weight: 600;
      font-size: 0.9em;
    }
    
    .theme-selector select {
      padding: 6px 28px 6px 10px;
      border-radius: 4px;
      font-size: 0.9em;
      border: 1px solid #ccc;
    }
    
    .custom-filter-container {
      width: 100%;
      padding: 10px 20px;
      background: var(--filter-bg, #f0f0f0);
      border-bottom: 1px solid #ccc;
      display: flex;
      align-items: center;
    }
    
    .custom-filter-input {
      width: 300px;
      padding: 8px 12px;
      border-radius: 4px;
      border: 2px solid var(--primary-color);
      font-size: 14px;
      background-color: var(--background-light);
      color: var(--text-primary);
      transition: all 0.2s ease;
    }
    
    .custom-filter-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(25, 182, 181, 0.3);
    }
    
    [data-theme="light"] .custom-filter-input {
      background-color: white;
    }
    
    [data-theme="light"] .custom-filter-input:focus {
      box-shadow: 0 0 0 2px rgba(0, 123, 138, 0.3);
    }
    
    .custom-filter-label {
      font-weight: 600;
      margin-right: 10px;
      color: var(--filter-text, #333);
    }
  </style>
</head>
<body>
  <div class="custom-header">
    <h1>FEAGI API Documentation - Rust Edition</h1>
    <div class="header-actions">
      <button class="header-button" id="expand-all">Expand All</button>
      <button class="header-button" id="collapse-all">Collapse All</button>
      <button class="header-button load-essential" id="load-essential">Load Essential</button>
      <button class="header-button load-barebones" id="load-barebones">Load Barebones</button>
      <div class="theme-selector">
        <span class="theme-selector-label">Theme:</span>
        <select id="theme-select">
          <option value="system">System</option>
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
      </div>
    </div>
  </div>

  <div class="custom-filter-container">
    <span class="custom-filter-label">Filter:</span>
    <input type="text" class="custom-filter-input" id="custom-filter-input" placeholder="Filter by tag, operation, or path...">
  </div>

  <div id="swagger-ui"></div>

  <script src="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.9.0/swagger-ui-bundle.js"></script>
  <script>
    function getSystemTheme() {
      return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function setTheme(theme) {
      const themeSelect = document.getElementById('theme-select');
      themeSelect.value = theme;

      // Determine the actual theme to apply
      let actualTheme = theme;
      if (theme === 'system') {
        actualTheme = getSystemTheme();
        localStorage.removeItem('feagi-theme');
      } else {
        localStorage.setItem('feagi-theme', theme);
      }

      // Apply theme by setting data-theme attribute on HTML element
      document.documentElement.setAttribute('data-theme', actualTheme);
      
      console.log('FEAGI Swagger UI: Theme changed to', theme, '(applying:', actualTheme + ')');
    }

    document.getElementById('theme-select').addEventListener('change', (e) => {
      setTheme(e.target.value);
    });
    
    // Listen for system theme changes when in 'system' mode
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      const currentTheme = localStorage.getItem('feagi-theme');
      if (!currentTheme || currentTheme === 'system') {
        setTheme('system');
      }
    });

    window.onload = function() {
      console.log('FEAGI Swagger UI: Initializing...');

      const savedTheme = localStorage.getItem('feagi-theme') || 'system';
      setTheme(savedTheme);

      if (typeof SwaggerUIBundle === 'undefined') {
        alert('SwaggerUIBundle failed to load. Check your network connection.');
        return;
      }

      // Force Swagger UI to use the current server (window.location.origin)
      // This ensures all API calls go to the same server that's serving Swagger UI
      const currentServerUrl = window.location.origin;
      console.log('FEAGI Swagger UI: Using server URL:', currentServerUrl);
      
      const ui = SwaggerUIBundle({
        url: "/api-docs/openapi.json",
        dom_id: '#swagger-ui',
        deepLinking: true,
        presets: [
          SwaggerUIBundle.presets.apis,
          SwaggerUIBundle.SwaggerUIStandalonePreset
        ],
        layout: "BaseLayout",
        docExpansion: "none",
        filter: false,
        persistAuthorization: true,
        // CRITICAL: Override server URL to always use current origin
        onComplete: function() {
          console.log('FEAGI Swagger UI: Loaded successfully');
          console.log('FEAGI Swagger UI: Server URL set to:', currentServerUrl);
        },
        tryItOutEnabled: true,
        // Add response interceptor for debugging
        responseInterceptor: (response) => {
          console.log('Swagger UI Response:', response);
          // Ensure response is properly formatted
          if (response && response.body) {
            try {
              const parsed = typeof response.body === 'string' ? JSON.parse(response.body) : response.body;
              console.log('Parsed response:', parsed);
            } catch (e) {
              console.error('Failed to parse response body:', e);
            }
          }
          return response;
        },
        // Add request interceptor for debugging
        requestInterceptor: (request) => {
          console.log('Swagger UI Request:', request);
          return request;
        },
        // Add error handler
        onFailure: (error) => {
          console.error('Swagger UI Error:', error);
          alert('Swagger UI failed to load. Check browser console for details.');
        },
        // Add completion handler
        onComplete: () => {
          console.log('Swagger UI loaded successfully');
        }
      });

      window.ui = ui;

      // Expand/collapse functionality
      document.getElementById('expand-all').addEventListener('click', () => {
        document.querySelectorAll('.opblock-tag-section').forEach(tag => {
          if (!tag.classList.contains('is-open')) {
            tag.querySelector('.opblock-tag').click();
          }
        });
      });

      document.getElementById('collapse-all').addEventListener('click', () => {
        document.querySelectorAll('.opblock-tag-section.is-open').forEach(tag => {
          tag.querySelector('.opblock-tag').click();
        });
      });

      // Load Essential genome button
      document.getElementById('load-essential').addEventListener('click', async () => {
        if (!confirm('Load Essential genome? This will replace the current genome.')) return;
        
        try {
          // Use window.location to build absolute URL (handles any base path)
          const baseUrl = window.location.origin + window.location.pathname.split('/swagger-ui')[0];
          const response = await fetch(baseUrl + '/v1/genome/upload/essential', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();
          alert('Essential genome loaded successfully!\n\n' + 
                'Cortical areas: ' + (result.cortical_area_count ?? 'N/A') + '\n' +
                'Brain regions: ' + (result.brain_region_count ?? 'N/A'));
          console.log('Essential genome loaded:', result);
        } catch (error) {
          console.error('Error loading essential genome:', error);
          alert('Failed to load essential genome:\n' + error.message);
        }
      });

      // Load Barebones genome button
      document.getElementById('load-barebones').addEventListener('click', async () => {
        if (!confirm('Load Barebones genome? This will replace the current genome.')) return;
        
        try {
          // Use window.location to build absolute URL (handles any base path)
          const baseUrl = window.location.origin + window.location.pathname.split('/swagger-ui')[0];
          const response = await fetch(baseUrl + '/v1/genome/upload/barebones', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();
          alert('Barebones genome loaded successfully!\n\n' + 
                'Cortical areas: ' + (result.cortical_area_count ?? 'N/A') + '\n' +
                'Brain regions: ' + (result.brain_region_count ?? 'N/A'));
          console.log('Barebones genome loaded:', result);
        } catch (error) {
          console.error('Error loading barebones genome:', error);
          alert('Failed to load barebones genome:\n' + error.message);
        }
      });

      // Custom filter functionality
      setTimeout(() => {
        const filterInput = document.getElementById('custom-filter-input');
        
        filterInput.addEventListener('input', function(e) {
          const searchTerm = e.target.value.trim().toLowerCase();

          if (!searchTerm) {
            document.querySelectorAll('.opblock-tag-section, .opblock').forEach(el => {
              el.style.display = '';
            });
            return;
          }

          document.querySelectorAll('.opblock-tag-section:not(.is-open)').forEach(tagSection => {
            const tagButton = tagSection.querySelector('.opblock-tag');
            if (tagButton) tagButton.click();
          });

          document.querySelectorAll('.opblock').forEach(opblock => {
            const pathEl = opblock.querySelector('.opblock-summary-path');
            const methodEl = opblock.querySelector('.opblock-summary-method');
            const descEl = opblock.querySelector('.opblock-summary-description');
            
            const pathText = pathEl ? pathEl.textContent.trim().toLowerCase() : '';
            const methodText = methodEl ? methodEl.textContent.trim().toLowerCase() : '';
            const descText = descEl ? descEl.textContent.trim().toLowerCase() : '';
            
            const isMatch = pathText.includes(searchTerm) || methodText.includes(searchTerm) || descText.includes(searchTerm);
            opblock.style.display = isMatch ? '' : 'none';
          });

          document.querySelectorAll('.opblock-tag-section').forEach(tagSection => {
            const tagEl = tagSection.querySelector('.opblock-tag');
            const tagText = tagEl ? tagEl.textContent.trim().toLowerCase() : '';
            const tagMatches = tagText.includes(searchTerm);
            const hasVisibleOps = Array.from(tagSection.querySelectorAll('.opblock')).some(op => op.style.display !== 'none');
            
            tagSection.style.display = (tagMatches || hasVisibleOps) ? '' : 'none';
            
            if (tagMatches) {
              tagSection.querySelectorAll('.opblock').forEach(op => { op.style.display = ''; });
            }
          });
        });
      }, 1000);

      console.log('FEAGI Swagger UI: Initialization complete');
    };
  </script>
</body>
</html>

