# Copyright 2025 Neuraville Inc.
# SPDX-License-Identifier: Apache-2.0

name: Staging PR Tests

on:
  pull_request_target:
    branches: staging

env:
  CARGO_TERM_COLOR: always

jobs:
  test-and-version-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR code
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.pull_request.head.repo.full_name }}
        ref: ${{ github.event.pull_request.head.ref }}
    
    - name: Check version number increase
      run: |
        # Get current version from PR branch (HEAD)
        CURRENT_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
        echo "PR branch version: $CURRENT_VERSION"
        
        # Download main branch Cargo.toml directly from GitHub
        echo "Downloading main Cargo.toml..."
        curl -s https://raw.githubusercontent.com/feagi/feagi-core/refs/heads/main/Cargo.toml -o main_cargo.toml
        
        # Download staging branch Cargo.toml directly from GitHub
        echo "Downloading staging Cargo.toml..."
        curl -s https://raw.githubusercontent.com/feagi/feagi-core/refs/heads/staging/Cargo.toml -o staging_cargo.toml
        
        # Get version from main branch
        MAIN_VERSION=$(grep '^version = ' main_cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
        echo "Main branch version: $MAIN_VERSION"
        
        # Get version from staging branch
        STAGING_VERSION=$(grep '^version = ' staging_cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
        echo "Staging branch version: $STAGING_VERSION"
        
        # Clean up temporary files
        rm main_cargo.toml staging_cargo.toml
        
        # Parse current PR version
        # Allow both base version (X.Y.Z) and beta version (X.Y.Z-beta.N)
        # The merge workflow will automatically add -beta.x if not present
        CURRENT_SEMANTIC=""
        CURRENT_BETA="0"
        
        if [[ "$CURRENT_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-beta\.([0-9]+)$ ]]; then
          # Already has beta suffix
          CURRENT_SEMANTIC="${BASH_REMATCH[1]}"
          CURRENT_BETA="${BASH_REMATCH[2]}"
          echo "PR semantic version: $CURRENT_SEMANTIC, beta: $CURRENT_BETA"
        elif [[ "$CURRENT_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
          # Base version without beta (will be converted to -beta.1 on merge)
          CURRENT_SEMANTIC="$CURRENT_VERSION"
          CURRENT_BETA="0"
          echo "PR semantic version: $CURRENT_SEMANTIC (no beta - will be converted to -beta.1 on merge)"
        else
          echo "❌ Error: PR version must be in format X.Y.Z or X.Y.Z-beta.N (e.g., 0.0.1 or 0.0.1-beta.1)"
          echo "Current version: $CURRENT_VERSION"
          exit 1
        fi
        
        # Parse main version (should be semantic only)
        if [[ ! "$MAIN_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
          echo "❌ Error: Main version should be semantic only (X.Y.Z)"
          echo "Main version: $MAIN_VERSION"
          exit 1
        fi
        
        MAIN_SEMANTIC="$MAIN_VERSION"
        echo "Main semantic version: $MAIN_SEMANTIC"
        
        # Parse staging version
        STAGING_SEMANTIC=""
        STAGING_BETA="0"
        
        if [[ "$STAGING_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-beta\.([0-9]+)$ ]]; then
          STAGING_SEMANTIC="${BASH_REMATCH[1]}"
          STAGING_BETA="${BASH_REMATCH[2]}"
          echo "Staging semantic version: $STAGING_SEMANTIC, beta: $STAGING_BETA"
        elif [[ "$STAGING_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
          STAGING_SEMANTIC="$STAGING_VERSION"
          STAGING_BETA="0"
          echo "Staging semantic version: $STAGING_SEMANTIC, no beta (assuming beta 0)"
        else
          echo "❌ Error: Invalid staging version format: $STAGING_VERSION"
          exit 1
        fi
        
        # Check that PR semantic version is > main semantic version
        # NOTE: Temporarily disabled for initial Rust release (0.x.x series)
        # Main branch still has Python 2.x.x version, Rust starts at 0.x.x
        # TODO: Re-enable once main branch is updated to Rust versioning
        # HIGHER_SEMANTIC=$(printf '%s\n%s\n' "$MAIN_SEMANTIC" "$CURRENT_SEMANTIC" | sort -V | tail -n1)
        # if [ "$HIGHER_SEMANTIC" != "$CURRENT_SEMANTIC" ] || [ "$CURRENT_SEMANTIC" = "$MAIN_SEMANTIC" ]; then
        #   echo "❌ Error: PR semantic version must be greater than main version"
        #   echo "PR semantic: $CURRENT_SEMANTIC, Main semantic: $MAIN_SEMANTIC"
        #   exit 1
        # fi
        echo "ℹ️  Version check skipped (initial Rust release: 0.x.x series)"
        
        # Check beta version requirements
        if [ "$CURRENT_SEMANTIC" = "$STAGING_SEMANTIC" ]; then
          # Same semantic version
          if [ "$CURRENT_BETA" = "0" ]; then
            # PR has base version, merge workflow will convert to -beta.(staging_beta + 1)
            EXPECTED_BETA=$((STAGING_BETA + 1))
            echo "✅ PR has base version, merge will convert to: $CURRENT_SEMANTIC-beta.$EXPECTED_BETA"
            echo "   (Staging: $STAGING_SEMANTIC-beta.$STAGING_BETA → PR: $CURRENT_SEMANTIC-beta.$EXPECTED_BETA)"
          elif [ "$CURRENT_BETA" -le "$STAGING_BETA" ]; then
            echo "❌ Error: For same semantic version, beta must be higher than staging"
            echo "PR: $CURRENT_SEMANTIC-beta.$CURRENT_BETA, Staging: $STAGING_SEMANTIC-beta.$STAGING_BETA"
            exit 1
          else
            echo "✅ Beta version incremented: $STAGING_SEMANTIC-beta.$STAGING_BETA → $CURRENT_SEMANTIC-beta.$CURRENT_BETA"
          fi
        else
          # Different semantic version
          if [ "$CURRENT_BETA" = "0" ]; then
            # PR has base version, merge workflow will convert to -beta.1
            echo "✅ New semantic version, merge will convert to: $CURRENT_SEMANTIC-beta.1"
            echo "   (Main: $MAIN_SEMANTIC → PR: $CURRENT_SEMANTIC-beta.1)"
          elif [ "$CURRENT_BETA" -lt "1" ]; then
            echo "❌ Error: Beta version must be at least 1"
            echo "PR: $CURRENT_SEMANTIC-beta.$CURRENT_BETA"
            exit 1
          else
            echo "✅ New semantic version with beta: $MAIN_SEMANTIC → $CURRENT_SEMANTIC-beta.$CURRENT_BETA"
          fi
        fi
        
        echo "✅ Version check passed: $STAGING_VERSION → $CURRENT_VERSION"
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Run tests (lib only, examples have known API migration issues)
      run: cargo test --workspace --lib --verbose
    
    - name: Check if builds
      run: cargo build --workspace --lib --verbose --exclude feagi-async
    
    - name: Check formatting
      run: cargo fmt --all -- --check
    
    - name: Run Clippy (lib and tests only)
      run: cargo clippy --workspace --lib --tests -- -D warnings

