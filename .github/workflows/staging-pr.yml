# Copyright 2025 Neuraville Inc.
# SPDX-License-Identifier: Apache-2.0

name: Staging PR Tests

on:
  pull_request_target:
    branches: staging

env:
  CARGO_TERM_COLOR: always

jobs:
  test-and-version-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR code
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.pull_request.head.repo.full_name }}
        ref: ${{ github.event.pull_request.head.ref }}
        fetch-depth: 0  # Full history for reliable diff
    
    - name: Detect changed files
      id: changes
      run: |
        # Fetch base branch
        git fetch origin staging
        
        # Find merge base
        MERGE_BASE=$(git merge-base origin/staging HEAD || echo "")
        
        if [ -z "$MERGE_BASE" ]; then
          echo "‚ö†Ô∏è  Cannot find merge base, assuming library changes"
          echo "library_changed=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Get changed files since merge base
        CHANGED_FILES=$(git diff --name-only "$MERGE_BASE" HEAD)
        echo "Changed files:"
        echo "$CHANGED_FILES"
        
        # Check if only infrastructure files changed
        # Infrastructure: .github/, scripts/, docs/ (but not crates/*/docs/)
        LIBRARY_CHANGED=false
        
        while IFS= read -r file; do
          # Skip empty lines
          [ -z "$file" ] && continue
          
          # Skip infrastructure-only files
          if [[ "$file" =~ ^\.github/ ]] || \
             [[ "$file" =~ ^scripts/ ]] || \
             [[ "$file" =~ ^docs/.*\.md$ ]] || \
             [[ "$file" =~ ^PUBLISHING.*\.md$ ]] || \
             [[ "$file" =~ ^tmp/ ]]; then
            continue
          fi
          
          # Anything else is library code (requires version bump)
          LIBRARY_CHANGED=true
          echo "Library change detected: $file"
          break
        done <<< "$CHANGED_FILES"
        
        echo "library_changed=$LIBRARY_CHANGED" >> $GITHUB_OUTPUT
        
        if [ "$LIBRARY_CHANGED" = "false" ]; then
          echo "‚ÑπÔ∏è  Only infrastructure changes detected - version check will be skipped"
        else
          echo "üì¶ Library code changed - version check required"
        fi
    
    - name: Check version number increase
      if: steps.changes.outputs.library_changed == 'true'
      run: |
        # Get current version from PR branch (HEAD)
        # Check both [package] and [workspace.package] sections
        CURRENT_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/' | tr -d '[:space:]')
        if [ -z "$CURRENT_VERSION" ]; then
          # Try workspace.package.version as fallback
          CURRENT_VERSION=$(grep 'workspace.package.version = ' Cargo.toml | head -1 | sed 's/.*version = "\(.*\)".*/\1/' | tr -d '[:space:]')
        fi
        if [ -z "$CURRENT_VERSION" ]; then
          echo "‚ùå Error: Could not extract version from Cargo.toml"
          echo "Searched for 'version = ' in Cargo.toml"
          exit 1
        fi
        echo "PR branch version: $CURRENT_VERSION"
        
        # Download main branch Cargo.toml directly from GitHub
        echo "Downloading main Cargo.toml..."
        curl -s https://raw.githubusercontent.com/feagi/feagi-core/refs/heads/main/Cargo.toml -o main_cargo.toml
        
        # Download staging branch Cargo.toml directly from GitHub
        echo "Downloading staging Cargo.toml..."
        curl -s https://raw.githubusercontent.com/feagi/feagi-core/refs/heads/staging/Cargo.toml -o staging_cargo.toml
        
        # Get version from main branch
        MAIN_VERSION=$(grep '^version = ' main_cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
        echo "Main branch version: $MAIN_VERSION"
        
        # Get version from staging branch
        STAGING_VERSION=$(grep '^version = ' staging_cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
        echo "Staging branch version: $STAGING_VERSION"
        
        # Clean up temporary files
        rm main_cargo.toml staging_cargo.toml
        
        # Parse current PR version
        # Allow both base version (X.Y.Z) and beta version (X.Y.Z-beta.N)
        # The merge workflow will automatically add -beta.x if not present
        CURRENT_SEMANTIC=""
        CURRENT_BETA="0"
        
        # Use grep to validate format instead of bash regex (more reliable)
        # Check if version matches X.Y.Z-beta.N pattern
        if echo "$CURRENT_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+-beta\.[0-9]+$'; then
          # Extract semantic and beta parts
          CURRENT_SEMANTIC=$(echo "$CURRENT_VERSION" | sed -E 's/-beta\.[0-9]+$//')
          CURRENT_BETA=$(echo "$CURRENT_VERSION" | sed -E 's/.*-beta\.([0-9]+)$/\1/')
          # Validate beta number
          if [ "$CURRENT_BETA" -lt 1 ] 2>/dev/null; then
            echo "‚ùå Error: Beta version must be at least 1, got: $CURRENT_BETA"
            exit 1
          fi
          echo "PR semantic version: $CURRENT_SEMANTIC, beta: $CURRENT_BETA"
        # Check if version matches X.Y.Z pattern (base version)
        elif echo "$CURRENT_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
          # Base version without beta (will be converted to -beta.1 on merge)
          CURRENT_SEMANTIC="$CURRENT_VERSION"
          CURRENT_BETA="0"
          echo "PR semantic version: $CURRENT_SEMANTIC (no beta - will be converted to -beta.1 on merge)"
        else
          echo "‚ùå Error: PR version must be in format X.Y.Z or X.Y.Z-beta.N (e.g., 0.0.1 or 0.0.1-beta.1)"
          echo "Current version: '$CURRENT_VERSION'"
          echo "Version length: ${#CURRENT_VERSION}"
          echo "Hex dump: $(echo -n "$CURRENT_VERSION" | xxd | head -1)"
          exit 1
        fi
        
        # Parse main version (should be semantic only)
        if [[ ! "$MAIN_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
          echo "‚ùå Error: Main version should be semantic only (X.Y.Z)"
          echo "Main version: $MAIN_VERSION"
          exit 1
        fi
        
        MAIN_SEMANTIC="$MAIN_VERSION"
        echo "Main semantic version: $MAIN_SEMANTIC"
        
        # Parse staging version
        STAGING_SEMANTIC=""
        STAGING_BETA="0"
        
        if [[ "$STAGING_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-beta\.([0-9]+)$ ]]; then
          STAGING_SEMANTIC="${BASH_REMATCH[1]}"
          STAGING_BETA="${BASH_REMATCH[2]}"
          echo "Staging semantic version: $STAGING_SEMANTIC, beta: $STAGING_BETA"
        elif [[ "$STAGING_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
          STAGING_SEMANTIC="$STAGING_VERSION"
          STAGING_BETA="0"
          echo "Staging semantic version: $STAGING_SEMANTIC, no beta (assuming beta 0)"
        else
          echo "‚ùå Error: Invalid staging version format: $STAGING_VERSION"
          exit 1
        fi
        
        # Check that PR semantic version is > main semantic version
        # NOTE: Allow transition from Python 2.x.x to Rust 0.x.x series
        # Main branch still has Python 2.x.x version, Rust starts at 0.x.x
        # Also allow same semantic version if PR has beta suffix (for staging beta releases)
        if [[ "$MAIN_SEMANTIC" =~ ^2\. ]] && [[ "$CURRENT_SEMANTIC" =~ ^0\. ]]; then
          echo "‚ÑπÔ∏è  Allowing transition from Python version ($MAIN_SEMANTIC) to Rust version ($CURRENT_SEMANTIC)"
        elif [ "$CURRENT_SEMANTIC" = "$MAIN_SEMANTIC" ] && [ "$CURRENT_BETA" -ge 1 ]; then
          # Same semantic version with beta suffix is allowed (for staging beta releases)
          echo "‚ÑπÔ∏è  Allowing same semantic version with beta suffix: $CURRENT_SEMANTIC-beta.$CURRENT_BETA"
        else
          HIGHER_SEMANTIC=$(printf '%s\n%s\n' "$MAIN_SEMANTIC" "$CURRENT_SEMANTIC" | sort -V | tail -n1)
          if [ "$HIGHER_SEMANTIC" != "$CURRENT_SEMANTIC" ] || [ "$CURRENT_SEMANTIC" = "$MAIN_SEMANTIC" ]; then
            echo "‚ùå Error: PR semantic version must be greater than main version"
            echo "PR semantic: $CURRENT_SEMANTIC, Main semantic: $MAIN_SEMANTIC"
            exit 1
          fi
        fi
        
        # Check beta version requirements
        # Special case: Allow transition from Python 2.x to Rust 0.x
        if [[ "$STAGING_SEMANTIC" =~ ^2\. ]] && [[ "$CURRENT_SEMANTIC" =~ ^0\. ]]; then
          echo "‚ÑπÔ∏è  Allowing transition from Python staging ($STAGING_SEMANTIC) to Rust version ($CURRENT_SEMANTIC)"
          if [ "$CURRENT_BETA" = "0" ]; then
            echo "‚úÖ PR has base version, merge will convert to: $CURRENT_SEMANTIC-beta.1"
          fi
        elif [ "$CURRENT_SEMANTIC" = "$STAGING_SEMANTIC" ]; then
          # Same semantic version
          if [ "$CURRENT_BETA" = "0" ]; then
            # PR has base version, merge workflow will convert to -beta.(staging_beta + 1)
            EXPECTED_BETA=$((STAGING_BETA + 1))
            echo "‚úÖ PR has base version, merge will convert to: $CURRENT_SEMANTIC-beta.$EXPECTED_BETA"
            echo "   (Staging: $STAGING_SEMANTIC-beta.$STAGING_BETA ‚Üí PR: $CURRENT_SEMANTIC-beta.$EXPECTED_BETA)"
          elif [ "$CURRENT_BETA" -le "$STAGING_BETA" ]; then
            echo "‚ùå Error: For same semantic version, beta must be higher than staging"
            echo "PR: $CURRENT_SEMANTIC-beta.$CURRENT_BETA, Staging: $STAGING_SEMANTIC-beta.$STAGING_BETA"
            exit 1
          else
            echo "‚úÖ Beta version incremented: $STAGING_SEMANTIC-beta.$STAGING_BETA ‚Üí $CURRENT_SEMANTIC-beta.$CURRENT_BETA"
          fi
        else
          # Different semantic version
          if [ "$CURRENT_BETA" = "0" ]; then
            # PR has base version, merge workflow will convert to -beta.1
            echo "‚úÖ New semantic version, merge will convert to: $CURRENT_SEMANTIC-beta.1"
            echo "   (Main: $MAIN_SEMANTIC ‚Üí PR: $CURRENT_SEMANTIC-beta.1)"
          elif [ "$CURRENT_BETA" -lt "1" ]; then
            echo "‚ùå Error: Beta version must be at least 1"
            echo "PR: $CURRENT_SEMANTIC-beta.$CURRENT_BETA"
            exit 1
          else
            echo "‚úÖ New semantic version with beta: $MAIN_SEMANTIC ‚Üí $CURRENT_SEMANTIC-beta.$CURRENT_BETA"
          fi
        fi
        
        echo "‚úÖ Version check passed: $STAGING_VERSION ‚Üí $CURRENT_VERSION"
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Run tests (lib only, examples have known API migration issues)
      run: cargo test --workspace --lib --verbose
    
    - name: Check if builds
      run: cargo build --workspace --lib --verbose --exclude feagi-async
    
    - name: Check formatting
      run: cargo fmt --all -- --check
    
    - name: Run Clippy (lib and tests only)
      run: cargo clippy --workspace --lib --tests -- -D warnings

