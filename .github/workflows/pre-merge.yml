# Copyright 2025 Neuraville Inc.
# SPDX-License-Identifier: Apache-2.0

name: Pre-Merge Tests

on:
  pull_request:
    branches: [main, staging]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: read

jobs:
  comprehensive-tests:
    name: Comprehensive Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout PR code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Main branch checks (PR to main only)
      if: github.base_ref == 'main'
      run: |
        BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
        echo "Source branch: $BRANCH_NAME"

        if [[ ! "$BRANCH_NAME" =~ ^Pre-Main:\ ([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
          echo "❌ Branch must follow 'Pre-Main: X.Y.Z'"
          exit 1
        fi
        BRANCH_VERSION="${BASH_REMATCH[1]}"
        CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
        if [ "$BRANCH_VERSION" != "$CARGO_VERSION" ]; then
          echo "❌ Branch version must match Cargo.toml"
          exit 1
        fi
        echo "✅ Branch format valid"

        CURRENT_VERSION=$(grep '^\[workspace\.package\]' -A 10 Cargo.toml | grep '^version = ' | head -1 | sed 's/version = "\(.*\)"/\1/')
        [ -z "$CURRENT_VERSION" ] && CURRENT_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
        if [[ ! "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "❌ Main PR version must be semantic only (X.Y.Z)"
          exit 1
        fi

        curl -s https://raw.githubusercontent.com/feagi/feagi-core/refs/heads/main/Cargo.toml -o main_cargo.toml
        MAIN_VERSION=$(grep '^\[workspace\.package\]' -A 10 main_cargo.toml | grep '^version = ' | head -1 | sed 's/version = "\(.*\)"/\1/')
        [ -z "$MAIN_VERSION" ] && MAIN_VERSION=$(grep '^version = ' main_cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
        rm main_cargo.toml

        HIGHER=$(printf '%s\n%s\n' "$MAIN_VERSION" "$CURRENT_VERSION" | sort -V | tail -n1)
        if [ "$HIGHER" != "$CURRENT_VERSION" ] || [ "$CURRENT_VERSION" = "$MAIN_VERSION" ]; then
          echo "❌ Version must be higher than main"
          exit 1
        fi
        echo "✅ Version check: $MAIN_VERSION → $CURRENT_VERSION"

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable

    - name: Install Rust components
      run: rustup component add clippy rustfmt

    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Dry run umbrella version bump preview
      run: |
        set -euo pipefail
        chmod +x scripts/bump-umbrella-version.sh
        DRY_RUN=true ./scripts/bump-umbrella-version.sh

    - name: Check formatting
      run: cargo fmt --all -- --check

    - name: Run Clippy
      run: cargo clippy --workspace --lib --tests -- -D warnings

    - name: Run tests (lib)
      run: cargo test --workspace --lib --verbose

    - name: Run Comprehensive Neural Dynamics Tests
      working-directory: crates/feagi-npu/burst-engine
      run: |
        echo "::group::Comprehensive Neural Dynamics"
        cargo test --test comprehensive_neural_dynamics --no-fail-fast -- --test-threads=1 --nocapture
        echo "::endgroup::"
        echo "::group::Extended Neural Dynamics"
        cargo test --test comprehensive_neural_dynamics_extended --no-fail-fast -- --test-threads=1 --nocapture
        echo "::endgroup::"

    - name: Generate Neural Dynamics Test Report
      if: always()
      working-directory: crates/feagi-npu/burst-engine
      run: |
        echo "# Neural Dynamics Test Report" >> $GITHUB_STEP_SUMMARY
        cargo test --test comprehensive_neural_dynamics -- --list 2>/dev/null | grep "test_" | wc -l | xargs -I {} echo "Total Tests: {}" >> $GITHUB_STEP_SUMMARY

    - name: Run NPU Integration Tests
      working-directory: crates/feagi-npu/burst-engine
      run: cargo test --tests --no-fail-fast

    - name: Run tests in release mode
      run: cargo test --workspace --lib --release --verbose

    - name: Check documentation
      run: cargo doc --no-deps --document-private-items

    - name: Build release (lib)
      run: cargo build --release --lib --verbose --workspace --exclude feagi-async

    - name: Verify crate metadata
      run: |
        for crate_dir in crates/*/ crates/feagi-npu/*/; do
          [ -f "$crate_dir/Cargo.toml" ] || continue
          crate_name=$(basename "$crate_dir")
          grep -q '^description = ' "$crate_dir/Cargo.toml" || { echo "Missing description in $crate_name"; exit 1; }
          grep -qE '^license(\.workspace)?\s*=\s*' "$crate_dir/Cargo.toml" || { echo "Missing license in $crate_name"; exit 1; }
        done
        echo "Crate metadata OK"

    # --no-verify required: verify step would resolve deps from crates.io (0.0.1-beta.18 not published yet)
    - name: Dry run package verification
      run: |
        for crate_dir in crates/*/ crates/feagi-npu/*/; do
          [ -f "$crate_dir/Cargo.toml" ] || continue
          crate_name=$(basename "$crate_dir")
          (cd "$crate_dir" && cargo package --quiet --no-verify) || { echo "Package failed: $crate_name"; exit 1; }
        done
        echo "All crates package successfully"

  microbench:
    name: Burst Engine Microbench Gate
    runs-on: ubuntu-latest
    needs: [comprehensive-tests]
    timeout-minutes: 30
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Run microbenchmarks
      run: cargo bench -p feagi-npu-burst-engine --bench ci_microbench

    - name: Regression gate (perf compare)
      run: |
        cargo run --bin perf_compare -- \
          --baseline perf/ci_microbench_baseline.json \
          --criterion-dir target/criterion

  pre-release-checks:
    name: Pre-Release Test Suite
    runs-on: ubuntu-latest
    needs: [comprehensive-tests, microbench]
    timeout-minutes: 60
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Run pre-release checks
      run: |
        chmod +x tests/pre_release_tests.sh
        tests/pre_release_tests.sh

  agent-sdk-live-contracts:
    name: Agent SDK Live HTTP Contract Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Build FEAGI HTTP API server
      run: cargo build -p feagi-api --example http_api_server

    - name: Start server in background
      run: |
        nohup ./target/debug/examples/http_api_server > feagi-api-server.log 2>&1 &
        echo $! > feagi-api-server.pid

    - name: Wait for server
      run: |
        for i in $(seq 1 180); do
          curl -sf "http://127.0.0.1:8000/swagger-ui/" >/dev/null && exit 0
          sleep 1
        done
        tail -200 feagi-api-server.log
        exit 1

    - name: Run live HTTP contract tests
      env:
        FEAGI_API_HOST: 127.0.0.1
        FEAGI_API_PORT: "8000"
      run: cargo test -p feagi-agent --test live_http_contract_tests --features sdk -- --nocapture

    - name: Upload server log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: feagi-api-server-log
        path: feagi-api-server.log
        if-no-files-found: warn

    - name: Stop server
      if: always()
      run: |
        [ -f feagi-api-server.pid ] && kill "$(cat feagi-api-server.pid)" 2>/dev/null || true

  publish-local-sim:
    name: Publish Simulation (local packaged deps gate)
    runs-on: ubuntu-latest
    needs: [comprehensive-tests, microbench, pre-release-checks]
    timeout-minutes: 45
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        shared-key: "publish-local-sim-pre-merge"
        save-if: true

    - name: Bump umbrella version (CI-only, for publish simulation)
      run: |
        chmod +x scripts/bump-umbrella-version.sh
        ./scripts/bump-umbrella-version.sh

    - name: Package and build against local packaged deps
      run: |
        set -euo pipefail
        ROOT="/tmp/feagi_local_publish_sim"
        DRIVER="${ROOT}/driver"
        EXTRACTED="${ROOT}/extracted"
        mkdir -p "${DRIVER}/.cargo" "${EXTRACTED}"

        CRATE_ORDER=(
          feagi-observability feagi-structures feagi-config feagi-npu-neural
          feagi-npu-runtime feagi-serialization feagi-state-manager
          feagi-npu-burst-engine feagi-npu-plasticity feagi-evolutionary
          feagi-brain-development feagi-sensorimotor feagi-services feagi-io
          feagi-agent feagi-api feagi-hal feagi
        )

        crate_path_for() {
          case "$1" in
            feagi-observability) echo "crates/feagi-observability" ;;
            feagi-structures) echo "crates/feagi-structures" ;;
            feagi-config) echo "crates/feagi-config" ;;
            feagi-npu-neural) echo "crates/feagi-npu/neural" ;;
            feagi-npu-runtime) echo "crates/feagi-npu/runtime" ;;
            feagi-serialization) echo "crates/feagi-serialization" ;;
            feagi-state-manager) echo "crates/feagi-state-manager" ;;
            feagi-npu-burst-engine) echo "crates/feagi-npu/burst-engine" ;;
            feagi-npu-plasticity) echo "crates/feagi-npu/plasticity" ;;
            feagi-evolutionary) echo "crates/feagi-evolutionary" ;;
            feagi-brain-development) echo "crates/feagi-brain-development" ;;
            feagi-sensorimotor) echo "crates/feagi-sensorimotor" ;;
            feagi-services) echo "crates/feagi-services" ;;
            feagi-io) echo "crates/feagi-io" ;;
            feagi-api) echo "crates/feagi-api" ;;
            feagi-agent) echo "crates/feagi-agent" ;;
            feagi-hal) echo "crates/feagi-hal" ;;
            feagi) echo "." ;;
            *) return 1 ;;
          esac
        }

        WORKSPACE_VERSION=$(awk '/^\[workspace\.package\]/{p=1;next} /^\[/{p=0} p && /^version = /{gsub(/version = |"/,""); print; exit}' Cargo.toml)
        # Resolve version for a crate (workspace or explicit)
        crate_version() {
          local path="$1"
          local crate="$2"
          if [ "$crate" = "feagi" ]; then
            awk -F'"' '/^version = / { print $2; exit }' "${path}/Cargo.toml"
          elif grep -q '^version\.workspace = true' "${path}/Cargo.toml" 2>/dev/null; then
            echo "$WORKSPACE_VERSION"
          else
            awk -F'"' '/^version = / { print $2; exit }' "${path}/Cargo.toml"
          fi
        }

        mkdir -p .cargo
        {
          echo "[patch.crates-io]"
          for crate in "${CRATE_ORDER[@]}"; do
            path="$(crate_path_for "${crate}")" || continue
            [ -f "${path}/Cargo.toml" ] || continue
            echo "${crate} = { path = \"${GITHUB_WORKSPACE}/${path}\" }"
          done
        } > .cargo/config.toml

        PACKAGES_DIR="${ROOT}/packages"
        mkdir -p "${PACKAGES_DIR}"
        for crate in "${CRATE_ORDER[@]}"; do
          path="$(crate_path_for "${crate}")" || continue
          [ -f "${path}/Cargo.toml" ] || continue
          cargo package --allow-dirty --no-verify --package "${crate}" --quiet
          version="$(crate_version "${path}" "${crate}")"
          mv "target/package/${crate}-${version}.crate" "${PACKAGES_DIR}/"
        done

        {
          echo "[patch.crates-io]"
          for crate in "${CRATE_ORDER[@]}"; do
            path="$(crate_path_for "${crate}")" || continue
            [ -f "${path}/Cargo.toml" ] || continue
            version="$(crate_version "${path}" "${crate}")"
            crate_file="${PACKAGES_DIR}/${crate}-${version}.crate"
            [ -f "${crate_file}" ] || { echo "Missing ${crate_file}"; exit 1; }
            dest="${EXTRACTED}/${crate}-${version}"
            rm -rf "${dest}"
            mkdir -p "${dest}"
            tar -xf "${crate_file}" -C "${dest}"
            src_dir="${dest}/${crate}-${version}"
            [ -f "${src_dir}/Cargo.toml" ] || { echo "Missing manifest in ${src_dir}"; exit 1; }
            echo "${crate} = { path = \"${src_dir}\" }"
          done
        } > "${DRIVER}/.cargo/config.toml"

        cd "${DRIVER}"
        for crate in "${CRATE_ORDER[@]}"; do
          path="$(crate_path_for "${crate}")" || continue
          [ -f "${GITHUB_WORKSPACE}/${path}/Cargo.toml" ] || continue
          version="$(crate_version "${GITHUB_WORKSPACE}/${path}" "${crate}")"
          manifest="${EXTRACTED}/${crate}-${version}/${crate}-${version}/Cargo.toml"
          [ -f "${manifest}" ] || { echo "Missing ${manifest}"; exit 1; }
          cargo generate-lockfile --manifest-path "${manifest}"
          cargo build --manifest-path "${manifest}" --locked --quiet
        done
        echo "Publish simulation OK"
