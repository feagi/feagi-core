# Copyright 2025 Neuraville Inc.
# SPDX-License-Identifier: Apache-2.0

name: Staging Merge - Prerelease

on:
  pull_request:
    branches: [ staging ]
    types: [ closed ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual publish'
        required: false
        default: 'Manual publish trigger'

env:
  CARGO_TERM_COLOR: always

jobs:
  prerelease:
    runs-on: ubuntu-latest
    # Run if PR was merged OR manually triggered
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: staging  # Ensure we're on the staging branch after merge
          fetch-depth: 0
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
  
      - name: Install Rust components
        run: |
          rustup component add rustfmt clippy
      
      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          # Keep cache invalidation tied to dependency changes
          shared-key: staging-merge-${{ hashFiles('**/Cargo.lock') }}
          save-if: true
      
      - name: Read workspace version
        id: version
        run: |
          VERSION=$(grep '^\[workspace\.package\]' -A 10 Cargo.toml | grep '^version = ' | head -1 | sed 's/version = "\(.*\)"/\1/')
          if [ -z "$VERSION" ]; then
            VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Workspace Version: $VERSION"
      
      - name: Check formatting
        run: cargo fmt --all -- --check
  
      - name: "Guard: verify local path dependency versions are consistent"
        run: |
          set -euo pipefail
  
          echo "üîé Verifying workspace path dependency version consistency..."
  
          # Extract workspace version (used by crates with `version.workspace = true`)
          WORKSPACE_VERSION="$(
            awk '
              BEGIN { in_ws=0 }
              /^\[workspace\.package\]/ { in_ws=1; next }
              /^\[/ { if (in_ws==1) exit }
              in_ws==1 && /^version = / {
                gsub(/version = /, "", $0);
                gsub(/"/, "", $0);
                print $0;
                exit
              }
            ' Cargo.toml
          )"
  
          if [ -z "${WORKSPACE_VERSION}" ]; then
            echo "‚ùå Failed to detect [workspace.package] version from Cargo.toml"
            exit 1
          fi
  
          declare -A CRATE_VERSIONS
  
          # Collect all crate versions (workspace + crates/* + crates/feagi-npu/*)
          for manifest in Cargo.toml crates/*/Cargo.toml crates/feagi-npu/*/Cargo.toml; do
            [ -f "$manifest" ] || continue
            name="$(grep -E '^name = ' "$manifest" | head -1 | sed 's/name = \"\\(.*\\)\"/\\1/')"
            if [ -z "$name" ]; then
              continue
            fi
  
            if grep -qE '^version\\.workspace = true' "$manifest"; then
              ver="$WORKSPACE_VERSION"
            else
              ver="$(grep -E '^version = ' "$manifest" | head -1 | sed 's/version = \"\\(.*\\)\"/\\1/')"
            fi
  
            if [ -n "$ver" ]; then
              CRATE_VERSIONS["$name"]="$ver"
            fi
          done
  
          mismatches=0
  
          # Scan manifests for inline deps of the form:
          #   dep = { version = "X", path = "../dep-path" }
          for manifest in Cargo.toml crates/*/Cargo.toml crates/feagi-npu/*/Cargo.toml; do
            [ -f "$manifest" ] || continue
  
            while IFS= read -r line; do
              dep="$(echo "$line" | sed -n 's/^\\s*\\([A-Za-z0-9_-][A-Za-z0-9_-]*\\)\\s*=.*/\\1/p')"
              req="$(echo "$line" | sed -n 's/.*version\\s*=\\s*\"\\([^\"]\\+\\)\".*/\\1/p')"
              path="$(echo "$line" | sed -n 's/.*path\\s*=\\s*\"\\([^\"]\\+\\)\".*/\\1/p')"
  
              [ -n "$dep" ] || continue
              [ -n "$req" ] || continue
              [ -n "$path" ] || continue
  
              case "$path" in
                ../*) ;;
                *) continue ;;
              esac
  
              # Normalize requirement (strip Cargo's exact pin prefix and caret)
              req="${req#=}"
              req="${req#^}"
  
              actual="${CRATE_VERSIONS[$dep]:-}"
              if [ -z "$actual" ]; then
                # Not a workspace crate (or renamed dependency); ignore.
                continue
              fi
  
              if [ "$req" != "$actual" ]; then
                echo "‚ùå Version mismatch in $manifest:"
                echo "   - dependency: $dep"
                echo "   - required:   $req"
                echo "   - actual:     $actual"
                echo "   - path:       $path"
                mismatches=$((mismatches + 1))
              fi
            done < <(grep -E 'path\\s*=\\s*\"\\.\\./[^\\\"]+\"' "$manifest" || true)
          done
  
          if [ "$mismatches" -gt 0 ]; then
            echo ""
            echo "‚ùå Found $mismatches workspace path dependency version mismatch(es)."
            echo "   This would cause cargo/clippy to fail with 'failed to select a version'."
            exit 1
          fi
  
          echo "‚úÖ Workspace path dependency versions are consistent."
      
      - name: Run Clippy (lib and tests only)
        run: cargo clippy --workspace --lib --tests -- -D warnings
      
      - name: Run tests (lib only, examples have known API migration issues)
        run: cargo test --workspace --lib --verbose
  
      - name: Run tests in release mode (lib only)
        run: cargo test --workspace --lib --release --verbose
      
      - name: Build release
        run: cargo build --release --lib --verbose
      
      - name: Publish workspace crates to crates.io
        run: |
          echo "üì¶ Publishing feagi-core workspace crates using committed umbrella versions..."
          echo ""
          
          # Run publisher with current committed versions. Without CHANGED_CRATES,
          # the script publishes all unpublished crates in dependency order.
          chmod +x scripts/publish-crates-smart.sh
          ./scripts/publish-crates-smart.sh
          
          echo ""
          echo "‚úÖ Successfully published workspace crates"
        continue-on-error: false
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_PUSH_TOKEN }}
      
      - name: Create prerelease tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Use timestamp-based tag for staging prereleases
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          TAG_NAME="staging-${TIMESTAMP}"
          echo "Creating prerelease tag: $TAG_NAME"
          
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        id: tag
      
      - name: Create GitHub Prerelease
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          release_name: Staging Release ${{ steps.tag.outputs.tag_name }}
          body: |
            üöÄ **FEAGI Core Staging Release**
            
            This is a beta/staging release from the staging branch. Workspace crates are published with a unified umbrella version.
            
            ## Installation
            
            Install individual crates from crates.io:
            
            ```toml
            [dependencies]
            feagi-npu-neural = "0.0.1-beta.X"  # Check crates.io for latest version
            feagi-npu-burst-engine = "0.0.1-beta.Y"
            ```
            
            Or use the workspace with feature flags:
            
            ```toml
            [dependencies]
            feagi = { version = "0.0.1-beta.Z", features = ["compute", "io"] }
            ```
            
            ## Release Information
            
            - **Tag:** ${{ steps.tag.outputs.tag_name }}
            - **Branch:** staging
            - **Commit:** ${{ github.sha }}
            - **Versioning Strategy:** Unified umbrella versioning
            
            ## Testing Status
            
            - ‚úÖ All workspace tests passed
            - ‚úÖ Package builds successfully
            - ‚úÖ Workspace crates published to crates.io
            - ‚úÖ Ready for testing and integration
            
            ## About Versioning
            
            This release uses **unified umbrella versioning**:
            - All workspace crates share the same release version
            - Dependency pins remain deterministic across crates
            - CI publishes unpublished crates in dependency order
          draft: false
          prerelease: true
      
      - name: Notify success
        run: |
          echo "üéâ Staging release ${{ steps.tag.outputs.tag_name }} completed successfully!"
          echo "‚úÖ Published workspace crates using unified versioning"
          echo "üè∑Ô∏è Tagged as: ${{ steps.tag.outputs.tag_name }}"
          echo ""
          echo "üìä Unified umbrella versioning applied across workspace crates"
  
