# Copyright 2025 Neuraville Inc.
# SPDX-License-Identifier: Apache-2.0

name: Verify Individual Crates

on:
  pull_request:
    branches: [ main, staging ]
    paths:
      - 'crates/**'
      - 'Cargo.toml'
      - 'Cargo.lock'

env:
  CARGO_TERM_COLOR: always

jobs:
  verify-crate-structure:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Rust Cache
      uses: Swatinem/rust-cache@v2
      with:
        shared-key: "verify-crates"
        save-if: true
    
    - name: Verify all crate metadata
      run: |
        echo "ğŸ” Verifying crate metadata for crates.io publication..."
        echo ""
        
        FAILED_CRATES=()
        
        for crate_dir in crates/*/; do
          if [ ! -f "$crate_dir/Cargo.toml" ]; then
            continue
          fi
          
          crate_name=$(basename "$crate_dir")
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Checking: $crate_name"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          CRATE_FAILED=false
          
          # Check required fields
          if ! grep -q '^name = ' "$crate_dir/Cargo.toml"; then
            echo "  âŒ Missing 'name' field"
            CRATE_FAILED=true
          fi
          
          # Check version (direct or workspace inheritance)
          if ! grep -qE '^version(\.workspace)? = ' "$crate_dir/Cargo.toml"; then
            echo "  âŒ Missing 'version' field"
            CRATE_FAILED=true
          fi
          
          if ! grep -q '^description = ' "$crate_dir/Cargo.toml"; then
            echo "  âŒ Missing 'description' field (required for crates.io)"
            CRATE_FAILED=true
          fi
          
          # Check license (direct or workspace inheritance)
          if ! grep -qE '^license(\.workspace)? = ' "$crate_dir/Cargo.toml"; then
            echo "  âŒ Missing 'license' field (required for crates.io)"
            CRATE_FAILED=true
          fi
          
          # Check authors (direct or workspace inheritance)
          if ! grep -qE '^authors(\.workspace)? = ' "$crate_dir/Cargo.toml"; then
            echo "  âŒ Missing 'authors' field (required for crates.io)"
            CRATE_FAILED=true
          fi
          
          # Check for path dependencies (should use workspace dependencies)
          if grep -q 'path = ".*/crates/' "$crate_dir/Cargo.toml" 2>/dev/null; then
            echo "  âš ï¸  Warning: Found absolute path dependencies (should use relative paths)"
          fi
          
          # Check for README
          if [ ! -f "$crate_dir/README.md" ]; then
            echo "  âš ï¸  Warning: No README.md (recommended for crates.io)"
          fi
          
          if [ "$CRATE_FAILED" = true ]; then
            FAILED_CRATES+=("$crate_name")
            echo "  âŒ $crate_name FAILED metadata check"
          else
            echo "  âœ… $crate_name has valid metadata"
          fi
          
          echo ""
        done
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š Metadata Verification Summary"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [ ${#FAILED_CRATES[@]} -gt 0 ]; then
          echo "âŒ Failed crates: ${#FAILED_CRATES[@]}"
          echo ""
          echo "Crates with missing metadata:"
          for crate in "${FAILED_CRATES[@]}"; do
            echo "  - $crate"
          done
          echo ""
          exit 1
        else
          echo "âœ… All crates have required metadata"
        fi
    
    - name: Verify individual crate builds
      run: |
        echo "ğŸ”¨ Building each crate individually..."
        echo ""
        
        FAILED_BUILDS=()
        
        for crate_dir in crates/*/; do
          if [ ! -f "$crate_dir/Cargo.toml" ]; then
            continue
          fi
          
          crate_name=$(basename "$crate_dir")
          echo "Building $crate_name..."
          
          if (cd "$crate_dir" && cargo build --lib --quiet 2>&1); then
            echo "  âœ… $crate_name builds successfully"
          else
            echo "  âŒ $crate_name failed to build"
            FAILED_BUILDS+=("$crate_name")
          fi
        done
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [ ${#FAILED_BUILDS[@]} -gt 0 ]; then
          echo "âŒ Failed to build: ${#FAILED_BUILDS[@]} crates"
          for crate in "${FAILED_BUILDS[@]}"; do
            echo "  - $crate"
          done
          exit 1
        else
          echo "âœ… All crates build successfully"
        fi
    
    - name: Verify crate packaging (dry-run publish check)
      run: |
        echo "ğŸ“¦ Verifying each crate can be packaged for publication..."
        echo ""
        echo "Note: This verifies package structure. Dependencies must be published"
        echo "in order (see PUBLISHING_ORDER.md) before dependent crates can be published."
        echo ""
        
        FAILED_PACKAGES=()
        
        for crate_dir in crates/*/; do
          if [ ! -f "$crate_dir/Cargo.toml" ]; then
            continue
          fi
          
          crate_name=$(basename "$crate_dir")
          # Extract package name from Cargo.toml (in case it differs from directory name)
          package_name=$(grep '^name = ' "$crate_dir/Cargo.toml" | head -1 | sed 's/name = "\(.*\)"/\1/')
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Packaging: $crate_name (package: $package_name)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Attempt to create the package (this will fail if dependencies aren't on crates.io,
          # but that's expected for unpublished workspace dependencies)
          # We use --no-verify to skip the build since we already built them
          # Note: cargo package resolves the entire workspace, so errors from other workspace
          # members are expected and should be ignored
          PACKAGE_OUTPUT=$(cargo package --package "$package_name" --allow-dirty --no-verify 2>&1)
          PACKAGE_EXIT=$?
          
          if [ $PACKAGE_EXIT -eq 0 ]; then
            echo "  âœ… $crate_name packages successfully"
          else
            # Check if the error is about missing dependencies on crates.io
            # This is expected for crates that depend on unpublished workspace members
            # Also check for workspace-wide resolution errors (cargo package resolves entire workspace)
            if echo "$PACKAGE_OUTPUT" | grep -qE "no matching package|location searched: crates.io|failed to get.*as a dependency"; then
              echo "  âš ï¸  $crate_name has unpublished workspace dependencies"
              echo "     This is expected - dependencies must be published first (see PUBLISHING_ORDER.md)"
              echo "     Note: cargo package resolves the entire workspace, so errors from other crates are expected"
            else
              echo "  âŒ $crate_name failed to package (non-dependency issue)"
              FAILED_PACKAGES+=("$crate_name")
              echo ""
              echo "Detailed error:"
              echo "$PACKAGE_OUTPUT"
              echo ""
            fi
          fi
        done
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š Packaging Verification Summary"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [ ${#FAILED_PACKAGES[@]} -gt 0 ]; then
          echo "âŒ Failed to package: ${#FAILED_PACKAGES[@]} crates"
          echo ""
          echo "Crates that cannot be published:"
          for crate in "${FAILED_PACKAGES[@]}"; do
            echo "  - $crate"
          done
          echo ""
          echo "These crates need to be fixed before they can be published to crates.io."
          exit 1
        else
          echo "âœ… All crates can be packaged successfully"
          echo "âœ… Ready for publication to crates.io"
        fi
    
    - name: Verify dependency versions
      run: |
        echo "ğŸ”— Verifying workspace dependency versions..."
        echo ""
        
        # Get workspace version
        WORKSPACE_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
        echo "Workspace version: $WORKSPACE_VERSION"
        echo ""
        
        MISMATCHED=()
        
        for crate_dir in crates/*/; do
          if [ ! -f "$crate_dir/Cargo.toml" ]; then
            continue
          fi
          
          crate_name=$(basename "$crate_dir")
          crate_version=$(grep '^version = ' "$crate_dir/Cargo.toml" | head -1 | sed 's/version = "\(.*\)"/\1/')
          
          if [ -n "$crate_version" ] && [ "$crate_version" != "$WORKSPACE_VERSION" ]; then
            echo "  âš ï¸  $crate_name version mismatch: $crate_version (workspace: $WORKSPACE_VERSION)"
            MISMATCHED+=("$crate_name: $crate_version")
          fi
        done
        
        if [ ${#MISMATCHED[@]} -gt 0 ]; then
          echo ""
          echo "âš ï¸  Warning: ${#MISMATCHED[@]} crates have different versions"
          echo "This is allowed for hybrid versioning, but verify it's intentional."
          echo ""
          for item in "${MISMATCHED[@]}"; do
            echo "  - $item"
          done
        else
          echo "âœ… All crates use workspace version: $WORKSPACE_VERSION"
        fi
    
    - name: Summary
      if: success()
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… All Crate Verification Checks Passed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "âœ… Metadata complete for all crates"
        echo "âœ… All crates build independently"
        echo "âœ… All crates package successfully"
        echo "âœ… Dependency versions verified"
        echo ""
        echo "ğŸ‰ Workspace is ready for publication to crates.io"


